<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Detalle Conductor - TAXIA CIMCO</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Inter', sans-serif; }
    html { scroll-behavior: smooth; }
    .text-neon-cyan { color: #00F0FF; }
    .btn-neon {
      background: linear-gradient(to right, #B300F2, #00F0FF);
      color: white;
      transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
      box-shadow: 0 4px 15px -5px #B300F2;
    }
    .btn-neon:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px -5px #00F0FF;
    }
    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-left-color: #00F0FF;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body class="bg-slate-900 text-gray-200">

  <!-- Header -->
  <header class="bg-slate-800 shadow-lg fixed top-0 w-full z-50">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <a href="ceo-panel.html" class="flex items-center space-x-2 transition-transform duration-200 hover:scale-105">
        <i class="fas fa-arrow-left text-2xl text-neon-cyan"></i>
        <h1 class="text-xl font-extrabold text-white hidden md:block">Volver al Panel</h1>
      </a>
      <h1 class="text-2xl font-extrabold text-white text-center flex-grow">Detalle de Conductor</h1>
      <div class="w-10"></div>
    </div>
  </header>

  <!-- Main -->
  <main class="py-24 px-4 md:px-8">
    <div class="container mx-auto max-w-6xl space-y-10">

      <!-- Info del conductor -->
      <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700">
        <h2 class="text-2xl font-bold mb-4">Información del Conductor</h2>
        <div id="infoConductor" class="space-y-2">
          <p id="nombreConductor" class="text-lg text-white">Nombre: Cargando...</p>
          <p id="idConductor" class="text-lg text-gray-400">ID: ...</p>
          <p id="saldoConductor" class="text-lg font-bold text-green-400">Saldo: $0</p>
        </div>
      </div>

      <!-- Botones de acciones -->
      <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
        <button id="btnRecargar" class="btn-neon px-4 py-2 rounded-md shadow flex-grow">
          <i class="fas fa-plus-circle mr-2"></i> Recargar $5.000
        </button>
        <button id="btnRestar" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-md shadow text-white flex-grow transition-colors">
          <i class="fas fa-minus-circle mr-2"></i> Cobro $2.000
        </button>
      </div>

      <!-- Gráfico -->
      <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700">
        <div class="flex flex-col md:flex-row justify-between items-center mb-4 space-y-2 md:space-y-0">
          <h2 class="text-2xl font-bold">Movimientos Financieros</h2>
          <select id="filtroFechas" class="bg-slate-700 text-white p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-neon-cyan">
            <option value="7">Última semana</option>
            <option value="30">Último mes</option>
            <option value="365">Último año</option>
            <option value="all">Todos</option>
          </select>
        </div>
        <div class="relative h-64 md:h-80">
          <canvas id="graficoMovimientos"></canvas>
        </div>
      </div>

      <!-- Historial -->
      <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold">Historial de Movimientos</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-700">
            <thead>
              <tr>
                <th class="px-6 py-3 text-left text-sm font-medium text-gray-400 uppercase">Monto</th>
                <th class="px-6 py-3 text-left text-sm font-medium text-gray-400 uppercase">Tipo</th>
                <th class="px-6 py-3 text-left text-sm font-medium text-gray-400 uppercase">Descripción</th>
                <th class="px-6 py-3 text-left text-sm font-medium text-gray-400 uppercase">Fecha</th>
              </tr>
            </thead>
            <tbody id="tablaMovimientos" class="divide-y divide-slate-700"></tbody>
          </table>
        </div>
      </div>

      <!-- Lista de viajes del conductor -->
      <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold">Viajes del Conductor</h2>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-slate-700">
            <thead>
              <tr>
                <th class="px-6 py-3 text-left text-sm font-medium text-gray-400 uppercase">Pasajero</th>
                <th class="px-6 py-3 text-left text-sm font-medium text-gray-400 uppercase">Estado</th>
                <th class="px-6 py-3 text-left text-sm font-medium text-gray-400 uppercase">Origen</th>
                <th class="px-6 py-3 text-left text-sm font-medium text-gray-400 uppercase">Destino</th>
                <th class="px-6 py-3 text-left text-sm font-medium text-gray-400 uppercase">Fecha</th>
                <th class="px-6 py-3 text-left text-sm font-medium text-gray-400 uppercase">Acciones</th>
              </tr>
            </thead>
            <tbody id="tablaViajes" class="divide-y divide-slate-700"></tbody>
          </table>
        </div>
      </div>

    </div>
  </main>

  <!-- Footer -->
  <footer class="bg-slate-800 text-gray-400 py-8 px-4 mt-12">
    <div class="container mx-auto text-center">
      <p>&copy; 2025 TAXIA CIMCO. Todos los derechos reservados.</p>
    </div>
  </footer>

  <!-- Firebase + lógica -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, addDoc, query, where, orderBy, getDocs, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCseKkOoHY8pbSnUWSEWyPR8et1BVccr7s",
      authDomain: "pelagic-chalice-467818-e1.firebaseapp.com",
      projectId: "pelagic-chalice-467818-e1",
      storageBucket: "pelagic-chalice-467818-e1.appspot.com",
      messagingSenderId: "191106268804",
      appId: "1:191106268804:web:8b2aa9689abaa35c880cd1",
      measurementId: "G-CPWSCLGKP2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const params = new URLSearchParams(window.location.search);
    const conductorId = params.get("uid");

    const nombreEl = document.getElementById("nombreConductor");
    const idEl = document.getElementById("idConductor");
    const saldoEl = document.getElementById("saldoConductor");
    const tablaMov = document.getElementById("tablaMovimientos");
    const btnRecargar = document.getElementById("btnRecargar");
    const btnRestar = document.getElementById("btnRestar");
    const filtroFechas = document.getElementById("filtroFechas");
    const graficoCanvas = document.getElementById("graficoMovimientos");
    const tablaViajes = document.getElementById("tablaViajes");
    let chartInstance;

    const formatearCOP = (valor) =>
      valor.toLocaleString("es-CO", { style: "currency", currency: "COP", minimumFractionDigits: 0 });

    async function cargarConductor() {
      if (!conductorId) return;
      idEl.textContent = "ID: " + conductorId;
      const docRef = doc(db, "conductores", conductorId);
      const snap = await getDoc(docRef);
      if (snap.exists()) {
        const data = snap.data();
        nombreEl.textContent = `Nombre: ${data.name || "Desconocido"}`;
        saldoEl.textContent = `Saldo: ${formatearCOP(data.saldo || 0)}`;
      }
    }

    async function registrarMovimiento(tipo, monto, descripcion) {
      if (!conductorId) return;
      const conductorRef = doc(db, "conductores", conductorId);
      await runTransaction(db, async (transaction) => {
        const conductorSnap = await transaction.get(conductorRef);
        if (!conductorSnap.exists()) throw new Error("Conductor no existe");
        const saldoActual = conductorSnap.data().saldo || 0;
        const nuevoSaldo = saldoActual + monto;
        transaction.update(conductorRef, { saldo: nuevoSaldo });
        const movRef = collection(db, "conductores", conductorId, "movimientos");
        await addDoc(movRef, {
          tipo,
          monto,
          descripcion,
          fecha: serverTimestamp()
        });
      });
      await cargarConductor();
      await cargarMovimientos();
    }

    btnRecargar.addEventListener("click", () => registrarMovimiento("recarga", 5000, "Recarga manual"));
    btnRestar.addEventListener("click", () => registrarMovimiento("gasto", -2000, "Cobro por viaje"));

    async function cargarMovimientos() {
      tablaMov.innerHTML = "";
      const movsRef = collection(db, "conductores", conductorId, "movimientos");
      const q = query(movsRef, orderBy("fecha", "desc"));
      const snaps = await getDocs(q);
      const datosGrafico = [];
      snaps.forEach(docSnap => {
        const mov = docSnap.data();
        const fecha = mov.fecha?.toDate ? mov.fecha.toDate() : new Date();
        const monto = mov.monto;
        const fila = `
          <tr>
            <td class="px-6 py-4 text-sm ${monto > 0 ? "text-green-400" : "text-red-400"}">${formatearCOP(monto)}</td>
            <td class="px-6 py-4 text-sm text-white">${mov.tipo}</td>
            <td class="px-6 py-4 text-sm text-gray-400">${mov.descripcion || "-"}</td>
            <td class="px-6 py-4 text-sm text-gray-400">${fecha.toLocaleDateString("es-CO")}</td>
          </tr>`;
        tablaMov.innerHTML += fila;
        datosGrafico.push({ fecha, monto });
      });
      generarGrafico(datosGrafico);
    }

    function generarGrafico(movimientos) {
      const diasFiltro = filtroFechas.value;
      let fechaLimite = null;
      if (diasFiltro !== "all") {
        fechaLimite = new Date();
        fechaLimite.setDate(fechaLimite.getDate() - parseInt(diasFiltro));
      }
      const filtrados = movimientos.filter(m => !fechaLimite || m.fecha >= fechaLimite);
      const agregados = {};
      filtrados.forEach(m => {
        const fecha = m.fecha.toLocaleDateString("es-CO");
        agregados[fecha] = (agregados[fecha] || 0) + m.monto;
      });
      const labels = Object.keys(agregados).reverse();
      const valores = Object.values(agregados).reverse();
      if (chartInstance) chartInstance.destroy();
      const ctx = graficoCanvas.getContext("2d");
      chartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Movimientos (COP)",
            data: valores,
            backgroundColor: valores.map(v => v > 0 ? "rgba(0, 240, 255, 0.6)" : "rgba(255, 0, 0, 0.6)"),
            borderColor: valores.map(v => v > 0 ? "#00F0FF" : "#FF0000"),
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true, ticks: { color: 'white' } },
            x: { ticks: { color: 'white' } }
          },
          plugins: { legend: { labels: { color: 'white' } } }
        }
      });
    }

    filtroFechas.addEventListener("change", cargarMovimientos);

    async function cargarViajes() {
      tablaViajes.innerHTML = "";
      const viajesRef = collection(db, "viajes");
      const q = query(viajesRef, where("conductorId", "==", conductorId), orderBy("fecha", "desc"));
      const snaps = await getDocs(q);

      snaps.forEach(docSnap => {
        const viaje = docSnap.data();
        const fecha = viaje.fecha?.toDate ? viaje.fecha.toDate() : new Date();
        const fila = `
          <tr>
            <td class="px-6 py-4 text-sm text-white">${viaje.pasajeroNombre || "-"}</td>
            <td class="px-6 py-4 text-sm ${viaje.estado === "finalizado" ? "text-green-400" : viaje.estado === "asignado" ? "text-yellow-400" : "text-gray-400"}">
              ${viaje.estado || "desconocido"}
            </td>
            <td class="px-6 py-4 text-sm text-gray-400">${viaje.origen || "-"}</td>
            <td class="px-6 py-4 text-sm text-gray-400">${viaje.destino || "-"}</td>
            <td class="px-6 py-4 text-sm text-gray-400">${fecha.toLocaleString("es-CO")}</td>
            <td class="px-6 py-4 text-sm">
              <a href="detalle-viaje.html?id=${docSnap.id}" target="_blank" class="text-neon-cyan hover:underline">Ver detalle</a>
            </td>
          </tr>`;
        tablaViajes.innerHTML += fila;
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "../index.html";
        return;
      }
      await cargarConductor();
      await cargarMovimientos();
      await cargarViajes();
    });
  </script>
</body>
</html>
