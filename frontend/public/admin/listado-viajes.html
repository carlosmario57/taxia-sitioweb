<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Listado de Viajes</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
</head>
<body class="p-4">

  <h2 class="mb-4">ðŸš– Listado de Viajes</h2>

  <table class="table table-bordered" id="tablaViajes">
    <thead>
      <tr>
        <th>ID Viaje</th>
        <th>Pasajero</th>
        <th>Origen</th>
        <th>Destino</th>
        <th>Conductor</th>
        <th>Estado</th>
        <th>AcciÃ³n</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Modal Asignar -->
  <div class="modal fade" id="modalAsignar" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Asignar/Reasignar Conductor</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <select id="selectConductor" class="form-select"></select>
          <input type="hidden" id="viajeSeleccionado">
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button class="btn btn-primary" id="btnGuardarAsignacion">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, addDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    // ðŸ”§ ConfiguraciÃ³n de Firebase (reemplaza con la tuya)
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_AUTH_DOMAIN",
      projectId: "TU_PROJECT_ID",
      storageBucket: "TU_STORAGE_BUCKET",
      messagingSenderId: "TU_SENDER_ID",
      appId: "TU_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const tablaBody = document.querySelector("#tablaViajes tbody");
    const selectConductor = document.getElementById("selectConductor");
    const viajeSeleccionado = document.getElementById("viajeSeleccionado");

    // ðŸ“Œ Cargar viajes
    async function cargarViajes() {
      tablaBody.innerHTML = "";
      const snapshot = await getDocs(collection(db, "viajes"));
      snapshot.forEach(docu => {
        const v = docu.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${docu.id}</td>
          <td>${v.pasajeroNombre || "N/A"}</td>
          <td>${v.origen || ""}</td>
          <td>${v.destino || ""}</td>
          <td>${v.conductorNombre || "No asignado"}</td>
          <td>${v.estado || "pendiente"}</td>
          <td><button class="btn btn-sm btn-primary btnAsignar" data-id="${docu.id}">Asignar</button></td>
        `;
        tablaBody.appendChild(tr);
      });

      document.querySelectorAll(".btnAsignar").forEach(btn => {
        btn.addEventListener("click", async () => {
          viajeSeleccionado.value = btn.dataset.id;
          await cargarConductores();
          new bootstrap.Modal(document.getElementById("modalAsignar")).show();
        });
      });
    }

    // ðŸ“Œ Cargar conductores
    async function cargarConductores() {
      selectConductor.innerHTML = "";
      const snapshot = await getDocs(collection(db, "usuarios"));
      snapshot.forEach(docu => {
        const u = docu.data();
        if (u.rol === "conductor") {
          const opt = document.createElement("option");
          opt.value = docu.id;
          opt.textContent = u.nombre || docu.id;
          selectConductor.appendChild(opt);
        }
      });
    }

    // ðŸ“Œ Guardar asignaciÃ³n
    document.getElementById("btnGuardarAsignacion").addEventListener("click", async () => {
      const viajeId = viajeSeleccionado.value;
      const conductorId = selectConductor.value;
      const conductorNombre = selectConductor.options[selectConductor.selectedIndex].text;

      const viajeRef = doc(db, "viajes", viajeId);
      await updateDoc(viajeRef, {
        conductorId,
        conductorNombre,
        estado: "asignado"
      });

      // Guardar log en "asignaciones"
      await addDoc(collection(db, "asignaciones"), {
        viajeId,
        conductorId,
        conductorNombre,
        despachadorId: auth.currentUser ? auth.currentUser.uid : "admin",
        fechaHora: new Date()
      });

      bootstrap.Modal.getInstance(document.getElementById("modalAsignar")).hide();
      cargarViajes();
    });

    cargarViajes();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
