<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel WhatsApp - TAXIA CIMCO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        html { scroll-behavior: smooth; }
        .text-neon-cyan { color: #00F0FF; }
        .text-neon-purple { color: #B300F2; }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #00F0FF;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-200">

<header class="bg-slate-800 shadow-lg fixed top-0 w-full z-50">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
        <a href="ceo-panel.html" class="flex items-center space-x-2 transition-transform duration-200 hover:scale-105">
            <i class="fas fa-arrow-left text-2xl text-neon-cyan"></i>
            <h1 class="text-xl font-extrabold text-white hidden md:block">Volver al Panel</h1>
        </a>
        <h1 class="text-2xl font-extrabold text-white text-center flex-grow">Panel WhatsApp</h1>
        <div class="w-10"></div> </div>
</header>

<main class="py-24 px-4 md:px-8">
    <div class="container mx-auto max-w-6xl space-y-10">

        <div class="bg-slate-800 p-6 rounded-xl shadow-lg border border-slate-700">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Solicitudes desde WhatsApp</h2>
                <div id="loadingIndicator" class="hidden">
                    <div class="spinner"></div>
                </div>
            </div>
            
            <p id="statusMessage" class="text-center text-gray-400 py-4 hidden">Cargando solicitudes...</p>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-slate-700">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-400 uppercase">Nombre</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-400 uppercase">TelÃ©fono</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-400 uppercase">Solicitud</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-400 uppercase">Estado</th>
                            <th class="px-6 py-3 text-left text-sm font-medium text-gray-400 uppercase">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaSolicitudes" class="divide-y divide-slate-700"></tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<footer class="bg-slate-800 text-gray-400 py-8 px-4 mt-12">
    <div class="container mx-auto text-center">
        <p>&copy; 2025 TAXIA CIMCO. Todos los derechos reservados.</p>
    </div>
</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, query, orderBy, getDocs, updateDoc, doc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { firebaseConfig } from "./firebase-config.js"; // Importa la configuraciÃ³n

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tablaSolicitudes = document.getElementById("tablaSolicitudes");
    const statusMessage = document.getElementById("statusMessage");
    const loadingIndicator = document.getElementById("loadingIndicator");

    async function cargarSolicitudes() {
        loadingIndicator.classList.remove("hidden");
        statusMessage.textContent = "Cargando solicitudes...";
        statusMessage.classList.remove("hidden");
        tablaSolicitudes.innerHTML = ""; // Limpiar tabla

        try {
            const solicitudesRef = collection(db, "solicitudes_whatsapp");
            const q = query(solicitudesRef, orderBy("fecha", "desc"));
            const snaps = await getDocs(q);

            if (snaps.empty) {
                statusMessage.textContent = "No hay solicitudes pendientes.";
                statusMessage.classList.remove("hidden");
            } else {
                statusMessage.classList.add("hidden");
                snaps.forEach(docSnap => {
                    const solicitud = docSnap.data();
                    const fila = document.createElement("tr");
                    fila.innerHTML = `
                        <td class="px-6 py-4 text-sm text-white">${solicitud.nombre || "N/A"}</td>
                        <td class="px-6 py-4 text-sm text-gray-400">${solicitud.telefono}</td>
                        <td class="px-6 py-4 text-sm text-gray-400">${solicitud.texto}</td>
                        <td class="px-6 py-4 text-sm ${solicitud.estado === "pendiente" ? "text-yellow-400" : "text-green-400"}">
                            ${solicitud.estado}
                        </td>
                        <td class="px-6 py-4 text-sm">
                            ${solicitud.estado === "pendiente"
                                ? `<button data-id="${docSnap.id}" class="btn-asignar bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded-md transition-colors">Asignar Conductor</button>`
                                : `<span class="text-gray-500">Completada</span>`
                            }
                        </td>
                    `;
                    tablaSolicitudes.appendChild(fila);
                });
            }
        } catch (error) {
            console.error("Error al cargar las solicitudes:", error);
            statusMessage.textContent = "Error al cargar las solicitudes. Intente de nuevo.";
            statusMessage.classList.remove("hidden");
        } finally {
            loadingIndicator.classList.add("hidden");
        }
    }

    // Usar event delegation para manejar clics en botones de "asignar"
    tablaSolicitudes.addEventListener("click", async (event) => {
        if (event.target.classList.contains("btn-asignar")) {
            const id = event.target.dataset.id;
            event.target.disabled = true;
            event.target.textContent = "Asignando...";
            try {
                const docRef = doc(db, "solicitudes_whatsapp", id);
                await updateDoc(docRef, { estado: "asignado" });
                alert("Conductor asignado a la solicitud âœ…");
                cargarSolicitudes(); // Recargar la tabla
            } catch (error) {
                console.error("Error al asignar conductor:", error);
                alert("Error al asignar conductor. Por favor, intente de nuevo.");
            }
        }
    });

    cargarSolicitudes();
</script>

<!--  Botón oculto solo para desarrollo -->
<button id="dev-clean-cache" style="display:none;position:fixed;bottom:10px;right:10px;z-index:9999;"></button>
<script>
document.addEventListener("keydown", async (e) => {
  if (e.ctrlKey && e.altKey && e.key.toLowerCase() === "l") {
    const regs = await navigator.serviceWorker.getRegistrations();
    for (const reg of regs) await reg.unregister();
    const names = await caches.keys();
    for (const n of names) await caches.delete(n);
    alert(" Caché y Service Workers eliminados.\nRecarga la página (Ctrl + F5).");
  }
});
</script>
<script src="/js/version-footer.js"></script>
</body>
</html>


