<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TAXIA CIMCO - Conductor Motocarga</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

  <!-- Manifest especÃ­fico de motocarga -->
  <link rel="manifest" href="/manifest-motocarga.webmanifest">
  <meta name="theme-color" content="#f97316">

  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
    .page-section { display: none; }
    .page-section.active { display: block; }
    #request-list-container { max-height: 400px; overflow-y: auto; }
    .request-card { border-left-width: 4px; }
    .message-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
                   z-index: 1000; padding: .75rem 1.5rem; border-radius: .5rem; opacity: 0;
                   transition: opacity .3s ease-in-out; }
    .message-box.show { opacity: 1; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

  <!-- Mensajes flotantes -->
  <div id="messageBox" class="message-box hidden"></div>

  <!-- Contenedor principal -->
  <div id="main-content" class="bg-white rounded-xl shadow-2xl p-6 md:p-10 w-full md:max-w-xl mx-auto space-y-6">

    <!-- Loading -->
    <div id="loadingSection" class="page-section active text-center">
      <i class="fas fa-box text-6xl text-yellow-500 animate-pulse"></i>
      <h2 class="text-2xl font-bold mt-4">Conectando...</h2>
      <p class="text-sm text-gray-500">Cargando datos del conductor</p>
    </div>

    <!-- Home conductor -->
    <div id="driverHomeSection" class="page-section text-center">
      <h1 class="text-3xl font-bold mb-4 text-gray-800">Panel Motocarga</h1>
      <div id="onlineStatus" class="flex items-center justify-center p-3 rounded-xl mb-4 text-white font-bold cursor-pointer" data-status="offline">
        <i class="fas fa-toggle-off mr-2"></i> <span>Estado: Desconectado</span>
      </div>
      <h2 class="text-xl font-bold mb-4 text-gray-700">Solicitudes Pendientes</h2>
      <div id="request-list-container" class="space-y-4 p-2 bg-gray-50 rounded-lg shadow-inner">
        <p id="no-requests-message" class="text-gray-500 italic">No hay solicitudes nuevas en este momento.</p>
      </div>
    </div>

    <!-- Detalle viaje -->
    <div id="requestDetailsSection" class="page-section">
      <button onclick="showSection('driverHomeSection')" class="text-blue-500 hover:text-blue-700 mb-4 flex items-center">
        <i class="fas fa-arrow-left mr-2"></i> Volver a la Lista
      </button>
      <h1 class="text-2xl font-bold mb-4 text-center">Detalles del Servicio</h1>
      <div id="request-details-card" class="bg-gray-50 p-6 rounded-lg shadow-inner mb-6 space-y-2">
        <p><strong>Recogida:</strong> <span id="pickupLocation"></span></p>
        <p><strong>Destino:</strong> <span id="destinationLocation"></span></p>
        <p><strong>Material:</strong> <span id="materialInfo"></span></p>
        <p><strong>Precio:</strong> $<span id="priceInfoValue"></span></p>
        <p><strong>ID Pasajero:</strong> <span id="passenger-id"></span></p>
      </div>

      <!-- Chat -->
      <div>
        <h3 class="text-xl font-bold mb-2">Chat con Pasajero</h3>
        <div id="chat-container" class="bg-gray-100 p-3 rounded-lg h-64 overflow-y-auto"></div>
        <form id="chat-form" class="flex items-center mt-2 space-x-2">
          <input id="chat-input" type="text" placeholder="Escribe un mensaje..." class="flex-1 p-2 border rounded-lg">
          <button class="bg-yellow-600 text-white px-4 py-2 rounded-lg"><i class="fas fa-paper-plane"></i></button>
        </form>
      </div>

      <!-- Acciones -->
      <div class="flex justify-around mt-4 space-x-4">
        <button id="arrivedBtn" onclick="updateTripStatus('arrived')" class="w-full bg-green-500 text-white py-2 rounded-lg hidden">LleguÃ©</button>
        <button id="completedBtn" onclick="updateTripStatus('completed')" class="w-full bg-blue-500 text-white py-2 rounded-lg hidden">Completar Servicio</button>
      </div>
      <button onclick="cancelService()" class="w-full bg-red-500 text-white py-2 rounded-lg mt-3">Cancelar Servicio</button>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { auth, db } from "../../public/js/firebase-config-motocarga.js";
    import { signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { doc, setDoc, updateDoc, collection, query, where, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const DRIVER_TYPE = "motocarga";
    let driverId = null;
    let currentRequestDocId = null;
    let locationWatcherId = null;
    let unsubscribeListeners = [];

    const showMessage = (msg, error=false) => {
      const box = document.getElementById("messageBox");
      box.textContent = msg;
      box.className = `message-box show ${error ? 'bg-red-200 text-red-800':'bg-green-200 text-green-800'}`;
      setTimeout(()=> box.classList.remove("show"), 3000);
    };

    const showSection = (id) => {
      document.querySelectorAll(".page-section").forEach(s=>s.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    };

    // Estado online/offline
    const updateOnlineStatusUI = (isOnline) => {
      const el = document.getElementById("onlineStatus");
      const txt = el.querySelector("span"); const icn = el.querySelector("i");
      if(isOnline){ el.style.background="#4ade80"; txt.textContent="Estado: Conectado"; icn.className="fas fa-toggle-on mr-2"; el.dataset.status="online"; }
      else{ el.style.background="#fca5a5"; txt.textContent="Estado: Desconectado"; icn.className="fas fa-toggle-off mr-2"; el.dataset.status="offline"; }
    };

    // GPS
    const updateDriverLocation = async (pos) => {
      const ref = doc(db, `conductores/${driverId}`);
      await setDoc(ref, { lat: pos.coords.latitude, lng: pos.coords.longitude, estadoVehiculo:"disponible", tipo: DRIVER_TYPE }, { merge:true });
    };

    const startLocationTracking = () => {
      if("geolocation" in navigator){
        locationWatcherId = navigator.geolocation.watchPosition(updateDriverLocation, e=>console.error(e), { enableHighAccuracy:true });
      }
    };

    const stopLocationTracking = () => { if(locationWatcherId){ navigator.geolocation.clearWatch(locationWatcherId); locationWatcherId=null; } };

    // Escuchar solicitudes
    const listenForRequests = () => {
      const q = query(collection(db, "viajes"), where("tipo","==",DRIVER_TYPE), where("estado","==","pendiente"));
      const unsub = onSnapshot(q, snap=>{
        const list = document.getElementById("request-list-container");
        const empty = document.getElementById("no-requests-message");
        snap.docChanges().forEach(change=>{
          const id = change.doc.id; const d = change.doc.data();
          if(change.type==="added"){
            const card=document.createElement("div");
            card.id=`req-${id}`;
            card.className="request-card bg-white p-3 rounded-lg shadow-md border-yellow-500";
            card.innerHTML=`<p><strong>De:</strong> ${d.origen}</p>
                            <p><strong>A:</strong> ${d.destino}</p>
                            <p><strong>Material:</strong> ${d.material||"-"}</p>
                            <p><strong>Precio:</strong> $${d.precio}</p>
                            <button class="accept bg-blue-500 text-white px-3 py-1 rounded mt-2">Aceptar</button>
                            <button class="reject bg-red-500 text-white px-3 py-1 rounded mt-2 ml-2">Rechazar</button>`;
            list.prepend(card); empty.classList.add("hidden");
            card.querySelector(".accept").onclick=()=>handleRequest("aceptado",id,d.pasajeroId);
            card.querySelector(".reject").onclick=()=>handleRequest("rechazado",id);
          }
          if(change.type==="removed"||change.type==="modified"){
            const card=document.getElementById(`req-${id}`); if(card) card.remove();
            if(list.children.length===1) empty.classList.remove("hidden");
          }
        });
      });
      unsubscribeListeners.push(unsub);
    };

    const handleRequest = async (estado, id, pasajeroId=null) => {
      const ref = doc(db, "viajes", id);
      if(estado==="aceptado"){
        await updateDoc(ref,{estado:"aceptado",conductorId:driverId,conductorTipo:DRIVER_TYPE,pasajeroId});
        currentRequestDocId=id;
        showSection("requestDetailsSection");
      } else if(estado==="rechazado"){
        await updateDoc(ref,{estado:"rechazado"});
      }
    };

    const updateTripStatus = async (estado) => {
      if(!currentRequestDocId) return;
      const ref = doc(db, "viajes", currentRequestDocId);
      await updateDoc(ref,{estado});
      if(estado==="finalizado"||estado==="cancelado"){ currentRequestDocId=null; showSection("driverHomeSection"); }
    };

    const cancelService = ()=>updateTripStatus("cancelado");

    // Chat
    const listenToChatMessages = () => {
      const q = collection(db, `viajes/${currentRequestDocId}/chat`);
      const unsub = onSnapshot(q,snap=>{
        snap.docChanges().forEach(change=>{
          if(change.type==="added"){
            const m=change.doc.data();
            const c=document.getElementById("chat-container");
            const div=document.createElement("div");
            div.className=`p-2 my-1 rounded-lg ${m.senderId===driverId?'bg-yellow-200 self-end':'bg-gray-300 self-start'}`;
            div.textContent=`${m.senderName}: ${m.text}`;
            c.appendChild(div); c.scrollTop=c.scrollHeight;
          }
        });
      });
      unsubscribeListeners.push(unsub);
    };

    window.onload=()=>{ onAuthStateChanged(auth,async u=>{ if(u){ driverId=u.uid; showSection("driverHomeSection"); updateOnlineStatusUI(false);} else await signInAnonymously(auth); });

      document.getElementById("onlineStatus").onclick=()=>{ const online=document.getElementById("onlineStatus").dataset.status==="online"; if(online){ stopLocationTracking(); unsubscribeListeners.forEach(u=>u()); updateOnlineStatusUI(false); } else{ startLocationTracking(); listenForRequests(); updateOnlineStatusUI(true); } };

      document.getElementById("chat-form").onsubmit=async e=>{ e.preventDefault(); const text=document.getElementById("chat-input").value.trim(); if(text && currentRequestDocId){ await addDoc(collection(db, `viajes/${currentRequestDocId}/chat`),{senderId:driverId,senderName:"Conductor",text,timestamp:new Date()}); document.getElementById("chat-input").value=""; } };
    };

    window.showSection=showSection; window.updateTripStatus=updateTripStatus; window.cancelService=cancelService;
  </script>

  <!-- Registro de Service Worker -->
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/service-worker.js")
      .then(() => console.log("âœ… SW registrado para esta app"))
      .catch(err => console.error("âŒ Error registrando SW:", err));
  }
  </script>
<!--  Botón oculto solo para desarrollo -->
<button id="dev-clean-cache" style="display:none;position:fixed;bottom:10px;right:10px;z-index:9999;"></button>
<script>
document.addEventListener("keydown", async (e) => {
  if (e.ctrlKey && e.altKey && e.key.toLowerCase() === "l") {
    const regs = await navigator.serviceWorker.getRegistrations();
    for (const reg of regs) await reg.unregister();
    const names = await caches.keys();
    for (const n of names) await caches.delete(n);
    alert(" Caché y Service Workers eliminados.\nRecarga la página (Ctrl + F5).");
  }
});
</script>
<script src="/js/version-footer.js"></script>
</body>
</html>



