<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Asignar Viajes - Panel Despachador</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fuente Inter -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
  <script type="module">
    // Importar Firebase y Auth
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, updateDoc, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Variables globales obligatorias de Canvas
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    let app;
    let db;
    let auth;
    let userId = null; // El ID del despachador actual

    /**
     * Inicializa Firebase y maneja la autenticación para obtener un userId seguro.
     */
    async function initFirebaseAndLoadData() {
        try {
            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config is missing.");
                document.getElementById('viajes-lista').innerHTML = `<p class="text-red-500">Error: La configuración de Firebase no está disponible.</p>`;
                return;
            }

            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Manejo de autenticación
            await new Promise(resolve => {
                const unsubscribe = onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                    } else if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                        // onAuthStateChanged se disparará de nuevo
                    } else {
                        // Si no hay token, iniciamos sesión anónimamente
                        const anonymousUser = await signInAnonymously(auth);
                        userId = anonymousUser.user.uid;
                    }
                    if (userId) {
                        unsubscribe(); // Detenemos el listener
                        resolve();
                    }
                });
            });

            // 2. Carga de datos después de la autenticación
            if (userId) {
                cargarViajesEnTiempoReal();
            } else {
                mostrarNotificacion("Error: No se pudo obtener el ID de usuario para Firestore.", "bg-red-600");
            }

            // Mostrar el userId
            document.getElementById('user-id-display').textContent = `ID Despachador: ${userId}`;

        } catch (error) {
            console.error("Error en la inicialización de Firebase:", error);
            mostrarNotificacion(`Error al iniciar la app: ${error.message}`, "bg-red-600");
        }
    }


    /**
     * Escucha los cambios en tiempo real en los viajes con estado "pendiente".
     */
    function cargarViajesEnTiempoReal() {
      if (!db || !userId) return;

      const contenedor = document.getElementById("viajes-lista");

      // La ruta pública para viajes: /artifacts/{appId}/public/data/viajes
      const viajesCollectionRef = collection(db, 'artifacts', appId, 'public', 'data', 'viajes');
      
      // Consulta: solo viajes con estado "pendiente"
      const q = query(viajesCollectionRef, where("estado", "==", "pendiente"));

      // Listener en tiempo real con onSnapshot
      onSnapshot(q, (snapshot) => {
        contenedor.innerHTML = ""; // Limpiar antes de renderizar

        if (snapshot.empty) {
            contenedor.innerHTML = `
                <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg shadow-inner" role="alert">
                    <p class="font-bold">¡Sin Viajes Pendientes!</p>
                    <p>Esperando nuevas solicitudes...</p>
                </div>
            `;
            return;
        }

        snapshot.forEach((docSnap) => {
          const viaje = docSnap.data();
          
          const card = document.createElement("div");
          card.className = "bg-white shadow-xl rounded-2xl p-6 mb-4 border-t-4 border-green-500 transition duration-300 hover:shadow-2xl";

          // Contenido de la tarjeta
          card.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <h3 class="text-xl font-bold text-gray-800">#VIAJE-${docSnap.id.substring(0, 6).toUpperCase()}</h3>
                <span class="text-xs font-semibold text-red-600 bg-red-100 py-1 px-3 rounded-full uppercase">PENDIENTE</span>
            </div>
            
            <p class="text-gray-700 mb-1 flex items-center">
                <i class="fas fa-arrow-up text-green-500 mr-3 w-4"></i>
                <strong class="font-semibold">Origen:</strong> ${viaje.origen}
            </p>
            <p class="text-gray-700 mb-4 flex items-center">
                <i class="fas fa-arrow-down text-green-500 mr-3 w-4"></i>
                <strong class="font-semibold">Destino:</strong> ${viaje.destino}
            </p>
            <p class="text-gray-700 mb-4 flex items-center">
                <i class="fas fa-user text-green-500 mr-3 w-4"></i>
                <strong class="font-semibold">Pasajero:</strong> ${viaje.pasajero}
            </p>

            <label class="block mt-4 text-sm font-medium text-gray-700">Asignar conductor:</label>
            <input type="text" id="conductor-${docSnap.id}" placeholder="Nombre o ID del conductor"
              class="w-full border border-gray-300 rounded-lg p-3 mt-1 focus:outline-none focus:ring-4 focus:ring-green-400 focus:border-green-400 transition duration-150 shadow-sm"
              onkeydown="if(event.key === 'Enter') asignarConductor('${docSnap.id}')">

            <button onclick="asignarConductor('${docSnap.id}')"
              class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-xl shadow-md hover:shadow-lg transition duration-150 transform hover:scale-[1.01] flex items-center justify-center">
              <i class="fas fa-taxi mr-2"></i> ✅ Asignar y Despachar
            </button>
          `;
          contenedor.appendChild(card);
        });
      }, (error) => {
        console.error("Error al escuchar viajes:", error);
        mostrarNotificacion(`Error al cargar los viajes: ${error.message}`, "bg-red-600");
      });
    }

    /**
     * Asigna un conductor y actualiza el estado del viaje en Firestore.
     * @param {string} viajeId - ID del documento del viaje.
     */
    async function asignarConductor(viajeId) {
      if (!db || !userId) {
          mostrarNotificacion("Error: La aplicación no está inicializada o autenticada.", "bg-red-600");
          return;
      }
      
      const input = document.getElementById(`conductor-${viajeId}`);
      const conductor = input.value.trim();

      if (conductor === "") {
        mostrarNotificacion("⚠️ Por favor, ingresa el nombre del conductor.", "bg-yellow-500");
        return;
      }

      try {
        // Ruta de destino: /artifacts/{appId}/public/data/viajes/{viajeId}
        const viajeRef = doc(db, 'artifacts', appId, 'public', 'data', 'viajes', viajeId);
        
        await updateDoc(viajeRef, {
          estado: "asignado",
          conductor: conductor,
          fechaAsignacion: new Date().toISOString(),
          despachadorId: userId 
        });

        mostrarNotificacion(`🚖 Viaje asignado a ${conductor}. ¡Actualización en tiempo real!`, "bg-green-600");
        
      } catch (error) {
        console.error("Error al asignar conductor:", error);
        mostrarNotificacion(`❌ Error al asignar el viaje: ${error.message}`, "bg-red-600");
      }
    }

    /**
     * Muestra una notificación temporal.
     */
    function mostrarNotificacion(message, bgColorClass) {
        const notifContainer = document.getElementById('notification-container');
        const notif = document.createElement('div');
        notif.className = `p-4 rounded-xl shadow-xl text-white font-semibold transition-opacity duration-300 ${bgColorClass}`;
        notif.textContent = message;

        notifContainer.appendChild(notif);
        
        setTimeout(() => {
            notif.classList.add('opacity-0');
            notif.addEventListener('transitionend', () => notif.remove());
        }, 4000);
    }

    window.onload = initFirebaseAndLoadData;
    window.asignarConductor = asignarConductor;
  </script>
  <!-- Íconos de Font Awesome (para iconos profesionales) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
  <!-- Contenedor de Notificaciones (reemplazo de alert()) -->
  <div id="notification-container" class="fixed top-5 right-5 z-50 space-y-2">
    <!-- Las notificaciones aparecerán aquí -->
  </div>
  
  <!-- Encabezado -->
  <header class="bg-green-700 text-white p-4 text-center shadow-lg">
    <h1 class="text-3xl font-extrabold tracking-tight">Panel Despachador CIMCO</h1>
    <p class="text-sm opacity-90 mt-1">Asignar y Despachar Viajes Pendientes</p>
  </header>

  <!-- Contenido Principal -->
  <main class="max-w-4xl mx-auto mt-8 p-4 md:p-8">
    
    <div class="bg-green-100 border-l-4 border-green-500 text-green-800 p-4 mb-6 rounded-lg shadow-sm" role="alert">
        <p class="font-bold">Identificador del Despachador</p>
        <p class="text-sm break-all" id="user-id-display">Cargando...</p>
    </div>

    <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
        <i class="fas fa-clipboard-list text-green-600 mr-3"></i>
        Lista de Viajes Pendientes
    </h2>
    
    <!-- Contenedor de Viajes -->
    <div id="viajes-lista" class="grid grid-cols-1 gap-6">
      <div class="text-center p-6 text-green-500"><i class="fas fa-spinner fa-spin"></i> Inicializando aplicación...</div>
    </div>
  </main>
</body>
</html>
