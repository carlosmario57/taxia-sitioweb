<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TAXI A CIMCO - Conductor MotoTaxi</title>
    <!-- Incluir Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluir Font Awesome para los iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1e293b;
        }
        .container {
            max-width: 95%;
            width: 100%;
        }
        .page-section {
            display: none;
        }
        .page-section.active {
            display: block;
        }
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .message-box.show {
            opacity: 1;
        }
        #request-list-container {
            max-height: 400px;
            overflow-y: auto;
        }
        .request-card {
            border-left-width: 4px;
        }
        .online-status-toggle {
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Mensaje de notificación -->
    <div id="messageBox" class="message-box hidden"></div>

    <div id="main-content" class="bg-white rounded-xl shadow-2xl p-6 md:p-10 w-full md:max-w-xl mx-auto flex flex-col items-center space-y-6">

        <p id="user-id-display" class="text-sm text-gray-400 self-start truncate hidden">ID de Conductor: <span id="user-id-text" class="font-mono"></span></p>

        <!-- Splash Screen con carga de GPS -->
        <div id="loadingSection" class="active page-section flex flex-col items-center justify-center p-8 text-center">
            <i class="fas fa-motorcycle text-6xl text-blue-500 animate-pulse"></i>
            <h2 class="text-2xl md:text-3xl font-bold mt-4">Conectando...</h2>
            <p class="text-sm text-gray-500 mt-2">Cargando datos y ubicación GPS. Por favor, espera.</p>
        </div>

        <!-- Pantalla de Inicio del Conductor -->
        <div id="driverHomeSection" class="page-section w-full text-center">
            <h1 class="text-3xl md:text-4xl font-bold mb-4 text-gray-800">Panel de Conductor</h1>
            <div id="onlineStatus" class="flex items-center justify-center p-3 rounded-xl mb-4 text-white font-bold online-status-toggle" data-status="offline" style="background-color: #fca5a5; color: #b91c1c;">
                <i class="fas fa-toggle-off mr-2"></i> Estado: Desconectado
            </div>
            
            <h2 class="text-xl md:text-2xl font-bold mb-4 text-gray-700">Solicitudes Pendientes</h2>
            <div id="request-list-container" class="space-y-4 p-2 bg-gray-50 rounded-lg shadow-inner">
                <p id="no-requests-message" class="text-gray-500 italic">No hay solicitudes nuevas en este momento.</p>
            </div>
        </div>

        <!-- Detalles de la Solicitud y Chat -->
        <div id="requestDetailsSection" class="page-section w-full">
            <button onclick="showSection('driverHomeSection')" class="text-blue-500 hover:text-blue-700 font-semibold mb-4 self-start flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Volver a la Lista
            </button>
            <h1 class="text-3xl md:text-4xl font-bold mb-4 text-center">Detalles del Servicio</h1>
            <div id="request-details-card" class="bg-gray-50 p-6 rounded-lg shadow-inner mb-6 space-y-3">
                <h2 class="text-xl font-bold mb-2 text-center text-blue-600">Servicio de MotoTaxi</h2>
                <div id="pickupInfo" class="flex items-center text-gray-700 font-semibold"><i class="fas fa-map-marker-alt text-red-500 mr-2"></i> Recogida: <span id="pickupLocation" class="ml-2 font-normal text-sm"></span></div>
                <div id="destInfo" class="flex items-center text-gray-700 font-semibold"><i class="fas fa-flag text-green-500 mr-2"></i> Destino: <span id="destinationLocation" class="ml-2 font-normal text-sm"></span></div>
                <div id="paxInfo" class="flex items-center text-gray-700 font-semibold"><i class="fas fa-users text-blue-500 mr-2"></i> Pasajeros: <span id="paxCountInfo" class="ml-2 font-normal"></span></div>
                <div id="priceInfo" class="flex items-center text-gray-700 font-semibold"><i class="fas fa-dollar-sign text-yellow-500 mr-2"></i> Propuesta: <span id="priceInfoValue" class="ml-2 font-normal"></span></div>
                <div id="statusInfo" class="text-center font-bold text-lg mt-4 p-2 rounded-md" style="background-color: #fca5a5; color: #b91c1c;">Estatus: <span id="requestStatus">Pendiente</span></div>
                <div id="passengerInfo" class="hidden text-center mt-4">
                    <h3 class="text-lg font-bold">Pasajero:</h3>
                    <p class="font-semibold"><i class="fas fa-user-circle text-blue-500 mr-2"></i><span id="passenger-name"></span></p>
                    <p class="font-semibold"><i class="fas fa-id-badge text-gray-500 mr-2"></i> ID: <span id="passenger-id"></span></p>
                </div>
            </div>

            <!-- Sección de Chat -->
            <div id="chat-section">
                <h3 class="text-xl font-bold text-gray-800 text-center mb-2">Chat con el Pasajero</h3>
                <div id="chat-container" class="bg-gray-100 p-4 rounded-lg shadow-inner flex flex-col h-80 overflow-y-auto">
                    <!-- Los mensajes se mostrarán aquí -->
                </div>
                <form id="chat-form" class="flex items-center mt-4 space-x-2">
                    <input type="text" id="chat-input" placeholder="Escribe un mensaje..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button type="submit" class="bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>

            <div id="trip-action-buttons" class="flex justify-around mt-6 space-x-4">
                <button id="arrivedBtn" onclick="updateTripStatus('arrived')" class="w-full bg-green-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-green-600 transition duration-300 hidden">Llegué</button>
                <button id="completedBtn" onclick="updateTripStatus('completed')" class="w-full bg-blue-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-blue-600 transition duration-300 hidden">Completar Viaje</button>
            </div>
            <button onclick="cancelService()" class="w-full bg-red-500 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:bg-red-600 transition duration-300 mt-4">Cancelar Viaje</button>
        </div>
        
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, onSnapshot, collection, query, where, getDocs, addDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, driverId, currentRequestDocId;
        let driverLocation = null;
        let isOnline = false;
        let unsubscribeListeners = [];

        // setLogLevel('debug'); // uncomment for debugging

        const showMessage = (message, isError = false) => {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = `message-box show ${isError ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`;
            setTimeout(() => {
                messageBox.classList.remove('show');
            }, 3000);
        };

        const showSection = (sectionId) => {
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        };

        // Haversine formula to calculate distance between two lat/lng points in km
        const getDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371; // Radius of the earth in km
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        };

        const deg2rad = (deg) => {
            return deg * (Math.PI / 180);
        };

        const updateOnlineStatusUI = () => {
            const statusToggle = document.getElementById('onlineStatus');
            const statusText = statusToggle.querySelector('span');
            const statusIcon = statusToggle.querySelector('i');

            if (isOnline) {
                statusToggle.style.backgroundColor = '#4ade80';
                statusToggle.style.color = '#166534';
                statusIcon.classList.remove('fa-toggle-off');
                statusIcon.classList.add('fa-toggle-on');
                statusText.textContent = 'Estado: Conectado';
            } else {
                statusToggle.style.backgroundColor = '#fca5a5';
                statusToggle.style.color = '#b91c1c';
                statusIcon.classList.remove('fa-toggle-on');
                statusIcon.classList.add('fa-toggle-off');
                statusText.textContent = 'Estado: Desconectado';
            }
        };

        const listenForRequests = () => {
            unsubscribeListeners.forEach(unsub => unsub());
            unsubscribeListeners = [];
            const requestsRef = collection(db, `artifacts/${appId}/public/data/service_requests`);
            const q = query(requestsRef, where("serviceType", "==", "mototaxi"), where("status", "==", "pending"));
            
            const unsubscribe = onSnapshot(q, (snapshot) => {
                const requestListContainer = document.getElementById('request-list-container');
                const noRequestsMessage = document.getElementById('no-requests-message');
                
                snapshot.docChanges().forEach((change) => {
                    const docId = change.doc.id;
                    const data = change.doc.data();

                    if (change.type === "added" || change.type === "modified") {
                        // Check if the request is within 5 km and not already accepted/rejected
                        const distance = getDistance(driverLocation.latitude, driverLocation.longitude, data.pickupCoordinates.lat, data.pickupCoordinates.lng);
                        
                        if (distance <= 5 && data.status === 'pending') {
                            let requestCard = document.getElementById(`request-${docId}`);
                            if (!requestCard) {
                                requestCard = document.createElement('div');
                                requestCard.id = `request-${docId}`;
                                requestCard.className = `request-card bg-white p-4 rounded-lg shadow-md border-green-500`;
                                requestCard.innerHTML = `
                                    <p class="font-bold text-lg text-blue-600 mb-1">Nueva Solicitud</p>
                                    <p class="text-sm">De: ${data.pickupAddress_manual}</p>
                                    <p class="text-sm">A: ${data.destinationAddress}</p>
                                    <p class="text-sm">Precio Propuesto: $${data.price}</p>
                                    <button class="accept-btn mt-2 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition">Aceptar</button>
                                    <button class="reject-btn mt-2 bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition">Rechazar</button>
                                `;
                                requestListContainer.prepend(requestCard);
                                noRequestsMessage.classList.add('hidden');

                                requestCard.querySelector('.accept-btn').addEventListener('click', async () => {
                                    await handleRequest('accepted', docId, data.passengerId);
                                });
                                requestCard.querySelector('.reject-btn').addEventListener('click', async () => {
                                    await handleRequest('rejected', docId, data.passengerId);
                                });
                            }
                        } else {
                            // If it's a new request but out of range, do nothing
                        }
                    } else if (change.type === "removed") {
                        const requestCard = document.getElementById(`request-${docId}`);
                        if (requestCard) {
                            requestCard.remove();
                        }
                        if (requestListContainer.children.length === 1) { // 1 is the no-requests message
                            noRequestsMessage.classList.remove('hidden');
                        }
                    }
                });
            }, (error) => {
                console.error("Error listening for requests: ", error);
                showMessage("Error de conexión al buscar solicitudes.", true);
            });
            unsubscribeListeners.push(unsubscribe);
        };

        const handleRequest = async (status, docId, passengerId) => {
            const requestRef = doc(db, `artifacts/${appId}/public/data/service_requests/${docId}`);
            try {
                if (status === 'accepted') {
                    await updateDoc(requestRef, { 
                        status: 'accepted',
                        assignedDriver: {
                            id: driverId,
                            name: 'Conductor MotoTaxi', // To be replaced with real name from auth profile if available
                            vehicle: 'MotoTaxi' // Or a more specific model
                        },
                        passengerId: passengerId // Add passenger ID for chat logic
                    });
                    currentRequestDocId = docId;
                    showMessage('¡Solicitud aceptada! Viaje iniciado.');
                    
                    // Show trip details and chat section
                    showSection('requestDetailsSection');
                    const requestData = (await getDoc(requestRef)).data();
                    document.getElementById('pickupLocation').textContent = requestData.pickupAddress_manual;
                    document.getElementById('destinationLocation').textContent = requestData.destinationAddress;
                    document.getElementById('paxCountInfo').textContent = requestData.paxCount || 'N/A';
                    document.getElementById('priceInfoValue').textContent = requestData.price;
                    document.getElementById('passenger-id').textContent = requestData.passengerId;
                    document.getElementById('passengerInfo').classList.remove('hidden');
                    document.getElementById('arrivedBtn').classList.remove('hidden');
                    document.getElementById('completedBtn').classList.add('hidden');
                    
                    listenToChatMessages();
                } else if (status === 'rejected') {
                    await updateDoc(requestRef, { status: 'rejected' });
                    showMessage('Solicitud rechazada.');
                    document.getElementById(`request-${docId}`).remove();
                }
            } catch (error) {
                console.error("Error handling request: ", error);
                showMessage('Error al procesar la solicitud. Intenta de nuevo.', true);
            }
        };

        const listenToChatMessages = () => {
            const chatPath = `artifacts/${appId}/public/data/service_requests/${currentRequestDocId}/chat`;
            const q = query(collection(db, chatPath));
            const unsubscribe = onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added') {
                        const message = change.doc.data();
                        const chatContainer = document.getElementById('chat-container');
                        const messageElement = document.createElement('div');
                        messageElement.className = `p-2 my-1 rounded-lg shadow-sm w-max ${message.senderId === driverId ? 'bg-blue-200 self-end' : 'bg-gray-300 self-start'}`;
                        messageElement.innerHTML = `
                            <span class="font-bold text-sm">${message.senderName}:</span>
                            <p>${message.text}</p>
                            <span class="text-xs text-gray-500">${new Date(message.timestamp.seconds * 1000).toLocaleTimeString()}</span>
                        `;
                        chatContainer.appendChild(messageElement);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }
                });
            }, (error) => {
                console.error("Error listening to chat messages: ", error);
                showMessage("Error de conexión en el chat.", true);
            });
            unsubscribeListeners.push(unsubscribe);
        };

        const updateTripStatus = async (status) => {
            if (!currentRequestDocId) return;
            const requestRef = doc(db, `artifacts/${appId}/public/data/service_requests/${currentRequestDocId}`);
            try {
                await updateDoc(requestRef, { status: status });
                if (status === 'arrived') {
                    showMessage('Has llegado a la ubicación del pasajero.');
                    document.getElementById('arrivedBtn').classList.add('hidden');
                    document.getElementById('completedBtn').classList.remove('hidden');
                } else if (status === 'completed') {
                    showMessage('Viaje completado. Buen trabajo.');
                    currentRequestDocId = null;
                    showSection('driverHomeSection');
                    document.getElementById('chat-container').innerHTML = ''; // Clear chat
                }
            } catch (error) {
                console.error("Error updating trip status: ", error);
                showMessage("Error al actualizar el estado del viaje.", true);
            }
        };

        const cancelService = async () => {
            if (!currentRequestDocId) return;
            const requestRef = doc(db, `artifacts/${appId}/public/data/service_requests/${currentRequestDocId}`);
            try {
                await updateDoc(requestRef, { status: 'cancelled' });
                showMessage('Viaje cancelado.');
                currentRequestDocId = null;
                showSection('driverHomeSection');
                document.getElementById('chat-container').innerHTML = '';
            } catch (error) {
                console.error("Error cancelling service: ", error);
                showMessage("Error al cancelar el viaje. Intenta de nuevo.", true);
            }
        };

        const getLocation = () => {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        driverLocation = position.coords;
                        console.log("GPS Location:", driverLocation);
                        showMessage("Ubicación GPS obtenida con éxito.");
                        showSection('driverHomeSection');
                        listenForRequests();
                    },
                    (error) => {
                        console.error("Geolocation Error: ", error);
                        showMessage("Error al obtener la ubicación GPS. Por favor, actívala.", true);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            } else {
                showMessage("La geolocalización no está disponible en este navegador.", true);
            }
        };

        const initializeFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length > 0) {
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    document.getElementById('onlineStatus').addEventListener('click', () => {
                        isOnline = !isOnline;
                        updateOnlineStatusUI();
                        if (isOnline) {
                            getLocation();
                        } else {
                            unsubscribeListeners.forEach(unsub => unsub());
                            unsubscribeListeners = [];
                        }
                    });
                    
                    document.getElementById('chat-form').addEventListener('submit', async (e) => {
                        e.preventDefault();
                        const chatInput = document.getElementById('chat-input');
                        const messageText = chatInput.value.trim();
                        if (messageText === "" || !currentRequestDocId) {
                            return;
                        }
                        const chatPath = `artifacts/${appId}/public/data/service_requests/${currentRequestDocId}/chat`;
                        try {
                            await addDoc(collection(db, chatPath), {
                                senderId: driverId,
                                senderName: "Conductor MotoTaxi",
                                text: messageText,
                                timestamp: new Date(),
                            });
                            chatInput.value = "";
                        } catch (e) {
                            console.error("Error sending message: ", e);
                            showMessage("Error al enviar el mensaje.", true);
                        }
                    });

                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            driverId = user.uid;
                            document.getElementById('user-id-text').textContent = driverId;
                            document.getElementById('user-id-display').classList.remove('hidden');
                            console.log("Authenticated as driver:", driverId);
                            showSection('driverHomeSection');
                            updateOnlineStatusUI();
                        } else {
                            try {
                                await signInAnonymously(auth);
                            } catch (error) {
                                console.error("Error signing in anonymously: ", error);
                                showMessage("Error de autenticación. Por favor, recarga la página.", true);
                            }
                        }
                    });

                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.error("Error with custom token:", error);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                } else {
                    showMessage("La configuración de Firebase no está disponible.", true);
                }
            } catch (e) {
                console.error("Error initializing Firebase:", e);
                showMessage("Error al inicializar la aplicación. Intenta de nuevo.", true);
            }
        };
        
        window.onload = initializeFirebase;
        window.showSection = showSection;
        window.updateTripStatus = updateTripStatus;
        window.cancelService = cancelService;
    </script>
</body>
</html>
