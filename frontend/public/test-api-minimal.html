<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TEST API Minimal - TAXIA CIMCO</title>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; padding: 18px; background:#f7fafc; color:#0f172a; }
    .box { background:#fff; padding:16px; border-radius:8px; box-shadow:0 6px 18px rgba(2,6,23,0.06); max-width:760px; margin:0 auto; }
    label { display:block; margin-top:10px; font-size:13px; color:#334155; }
    input, textarea { width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:6px; margin-top:6px; font-size:14px; }
    button { margin-top:12px; background:#16a34a; color:#fff; border:0; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
    pre { background:#0f172a; color:#d1fae5; padding:12px; border-radius:6px; overflow:auto; max-height:320px; margin-top:12px; }
    .hint { font-size:13px; color:#475569; margin-top:8px; }
    .warn { color:#b91c1c; font-weight:600; }
  </style>
</head>
<body>
  <div class="box">
    <h2>TEST API Minimal — solicitarServicio</h2>

    <label>URL de la API (edítala si tu endpoint es diferente)</label>
    <input id="apiUrl" value="https://us-central1-pelagic-chalice-467818-e1.cloudfunctions.net/api/solicitarServicio" />

    <label>pasajeroId (UID)</label>
    <input id="pasajeroId" placeholder="uid_pasajero_ejemplo" />

    <label>origen (lat,lng)</label>
    <input id="origen" value="10.4630,-73.2532" />

    <label>destino (lat,lng)</label>
    <input id="destino" value="10.4700,-73.2600" />

    <label>tipoServicio</label>
    <input id="tipoServicio" value="Estándar" />

    <button id="sendBtn">▶ Enviar solicitud (POST)</button>

    <p class="hint">Resultado (impreso también en <code>console.log</code>):</p>
    <pre id="result">Esperando envío...</pre>

    <p class="hint">Si desde el navegador obtienes <span class="warn">CORS</span> o la consola muestra algo como <code>Access to fetch ... has been blocked by CORS policy</code>, lee la sección <strong>¿Problemas con CORS?</strong> más abajo.</p>
  </div>

  <script>
    document.getElementById('sendBtn').addEventListener('click', async () => {
      const apiUrl = document.getElementById('apiUrl').value.trim();
      const pasajeroId = document.getElementById('pasajeroId').value.trim();
      const origenText = document.getElementById('origen').value.trim();
      const destinoText = document.getElementById('destino').value.trim();
      const tipoServicio = document.getElementById('tipoServicio').value.trim() || 'Estándar';
      const out = document.getElementById('result');

      out.textContent = 'Enviando...';
      console.log('Enviando a', apiUrl);

      // Validaciones mínimas
      if (!apiUrl) { out.textContent = 'Error: configura apiUrl'; return; }
      if (!pasajeroId) { out.textContent = 'Error: ingresa pasajeroId (UID)'; return; }

      // parse coords
      const [olat, olng] = origenText.split(',').map(s => s && s.trim());
      const [dlat, dlng] = destinoText.split(',').map(s => s && s.trim());

      const payload = {
        pasajeroId,
        origen: { lat: parseFloat(olat), lng: parseFloat(olng) },
        destino: { lat: parseFloat(dlat), lng: parseFloat(dlng) },
        tipoServicio
      };

      try {
        const resp = await fetch(apiUrl, {
          method: 'POST',
          mode: 'cors',               // modo CORS
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const text = await resp.text(); // leemos texto para manejar errores no-json
        let data = text;
        try { data = JSON.parse(text); } catch(e){ /* respuesta no-JSON */ }

        console.log('HTTP status:', resp.status, resp.statusText);
        console.log('response raw:', text);
        console.log('response parsed:', data);

        if (!resp.ok) {
          out.textContent = `ERROR HTTP ${resp.status}\n\n${typeof data === 'object' ? JSON.stringify(data,null,2) : data}`;
        } else {
          out.textContent = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;
        }
      } catch (err) {
        console.error('Fetch error:', err);
        out.textContent = 'Network / Fetch error: ' + (err && err.message ? err.message : String(err));
      }
    });
  </script>

  <hr style="max-width:760px;margin:18px auto;border:none;height:1px;background:#e6eef8" />

  <div class="box" style="max-width:760px;margin-top:6px;">
    <h3>¿Problemas con CORS?</h3>
    <p class="hint">
      Si al abrir este archivo localmente (file://) ves “<strong>origin 'null'</strong>” o error CORS:
    </p>
    <ol class="hint">
      <li>Abre el archivo vía servidor (no con file://). Ejemplo rápido: desde la raíz del proyecto ejecuta <code>npx serve frontend/public</code> o usa <code>npm run dev</code> si ya tienes un dev-server. Abrir via <code>http://localhost:5000/test-api-minimal.html</code> evita origin null.</li>
      <li>Si aún hay CORS, en tu backend (Express / functions) añade <code>cors</code> y habilítalo. En <strong>functions/src/index.ts</strong> (o donde inicialices Express) agrega exactamente:
        <pre style="background:#111;color:#9ff;padding:8px;border-radius:6px">import cors from 'cors';
app.use(cors({ origin: true }));
app.options('*', cors());</pre>
        Luego rebuild/deploy: desde carpeta <code>functions</code> ejecuta <code>npm run build && firebase deploy --only functions</code>.
      </li>
      <li>Alternativa para depuración rápida desde máquina: prueba el endpoint con <code>curl</code> (evita CORS):
        <pre style="background:#111;color:#9ff;padding:8px;border-radius:6px">curl -X POST -H "Content-Type: application/json" \
-d '{"pasajeroId":"UID_DE_PRUEBA","origen":{"lat":10.463,"lng":-73.253},"destino":{"lat":10.47,"lng":-73.26},"tipoServicio":"Estándar"}' \
https://us-central1-pelagic-chalice-467818-e1.cloudfunctions.net/api/solicitarServicio</pre>
      </li>
    </ol>
    <p class="hint">Si quieres, te doy el snippet listo para pegar en tu <code>index.ts</code> y el comando exacto para redeploy — dime si quieres que lo añada ahora y lo hago.</p>
  </div>
</body>
</html>
