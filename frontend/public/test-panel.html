<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Pruebas de Servicio CIMCO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2fe; /* Fondo azul muy claro */
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
        }
        .card {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-color: #3b82f6;
            transition: background-color 0.15s;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-warning {
            background-color: #f59e0b;
        }
    </style>
</head>
<body class="p-6">

    <div class="container mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">‚öôÔ∏è Panel de Pruebas: Flujo de Servicio</h1>
        <p class="text-center text-gray-600 mb-8">
            Utiliza este panel para simular una solicitud de servicio llamando a tu Cloud Function HTTP.
        </p>

        <!-- Secci√≥n de Configuraci√≥n -->
        <div class="card bg-white p-6 rounded-xl mb-8">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2 text-blue-600">Configuraci√≥n de la Prueba</h2>
            <div class="space-y-4">
                
                <div>
                    <label for="api-url" class="block text-sm font-medium text-gray-700">URL de la Cloud Function (API)</label>
                    <!-- URL ACTUALIZADA CON EL VALOR DE TU CONSOLA -->
                    <input type="text" id="api-url" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border focus:border-blue-500" value="https://us-central1-pelagic-chalice-467818-e1.cloudfunctions.net/api/solicitarServicio" placeholder="https://[region]-[project-id].cloudfunctions.net/api/solicitarServicio" readonly>
                    <p class="mt-1 text-xs text-green-600 font-medium">‚úÖ URL de la API detectada y configurada autom√°ticamente.</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="pasajero-id" class="block text-sm font-medium text-gray-700">ID del Pasajero (UID)</label>
                        <input type="text" id="pasajero-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border" placeholder="e.g., k39d...A1b">
                        <p class="mt-1 text-xs text-gray-500">UID del Pasajero registrado en login-pasajero.html</p>
                    </div>
                    <div>
                        <label for="conductor-id" class="block text-sm font-medium text-gray-700">ID del Conductor (UID)</label>
                        <input type="text" id="conductor-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border" placeholder="e.g., Lk7w...C2y">
                        <p class="mt-1 text-xs text-gray-500">UID del Conductor registrado en login-conductor.html</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="origen" class="block text-sm font-medium text-gray-700">Ubicaci√≥n Origen (Lat,Lng)</label>
                        <input type="text" id="origen" value="10.4630, -73.2532" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border" placeholder="lat,lng">
                    </div>
                    <div>
                        <label for="destino" class="block text-sm font-medium text-gray-700">Ubicaci√≥n Destino (Lat,Lng)</label>
                        <input type="text" id="destino" value="10.4700, -73.2600" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border" placeholder="lat,lng">
                    </div>
                </div>

                <button id="solicitar-btn" class="w-full py-3 px-4 rounded-lg shadow-md text-white font-semibold btn-primary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    üî¥ SOLICITAR SERVICIO (Llamar a la API)
                </button>
            </div>
        </div>

        <!-- Secci√≥n de Resultados de la API -->
        <div class="card bg-gray-800 p-6 rounded-xl text-white">
            <h2 class="text-xl font-semibold mb-4 border-b border-gray-700 pb-2 text-indigo-300">Respuesta de la API</h2>
            
            <div id="loading-spinner" class="text-center p-4 hidden">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-400 mx-auto"></div>
                <p class="mt-2 text-indigo-400">Enviando solicitud...</p>
            </div>

            <pre id="api-response" class="text-sm overflow-x-auto bg-gray-900 p-4 rounded-lg">Esperando solicitud...</pre>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const apiUrlInput = document.getElementById('api-url');
            const pasajeroIdInput = document.getElementById('pasajero-id');
            const conductorIdInput = document.getElementById('conductor-id');
            const origenInput = document.getElementById('origen');
            const destinoInput = document.getElementById('destino');
            const solicitarBtn = document.getElementById('solicitar-btn');
            const apiResponsePre = document.getElementById('api-response');
            const loadingSpinner = document.getElementById('loading-spinner');

            solicitarBtn.addEventListener('click', async () => {
                const apiUrl = apiUrlInput.value;
                const pasajeroId = pasajeroIdInput.value.trim();
                const conductorId = conductorIdInput.value.trim();
                const origen = origenInput.value.trim();
                const destino = destinoInput.value.trim();

                if (!pasajeroId || !conductorId) {
                    apiResponsePre.textContent = "ERROR: Los IDs de Pasajero y Conductor son obligatorios para la prueba. Debes ingresar los UIDs que obtuviste al registrarte en los formularios de login.";
                    apiResponsePre.classList.add('text-red-400');
                    return;
                }
                
                apiResponsePre.classList.remove('text-red-400');
                apiResponsePre.textContent = 'Enviando...';
                loadingSpinner.classList.remove('hidden');
                solicitarBtn.disabled = true;

                // Dividir coordenadas
                const [latOrigen, lngOrigen] = origen.split(',').map(s => s.trim());
                const [latDestino, lngDestino] = destino.split(',').map(s => s.trim());


                // Datos que se enviar√°n a la Cloud Function (simulando el cuerpo de la solicitud)
                const requestBody = {
                    pasajeroId: pasajeroId,
                    conductorId: conductorId,
                    origen: {
                        lat: parseFloat(latOrigen),
                        lng: parseFloat(lngOrigen)
                    },
                    destino: {
                        lat: parseFloat(latDestino),
                        lng: parseFloat(lngDestino)
                    },
                    tipoServicio: 'Est√°ndar', 
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestBody),
                    });

                    // Leer la respuesta de la API
                    const responseText = await response.text();
                    let data;
                    
                    try {
                        data = JSON.parse(responseText);
                    } catch (e) {
                        // Si la respuesta no es un JSON, la tratamos como texto plano (posible error)
                        throw new Error(`Respuesta no JSON: ${responseText}`);
                    }


                    if (!response.ok) {
                        // Manejo de errores HTTP (400, 500, etc.)
                        throw new Error(data.message || `Error HTTP: ${response.status} - ${response.statusText}. Respuesta de la funci√≥n: ${JSON.stringify(data, null, 2)}`);
                    }

                    // Mostrar la respuesta exitosa
                    apiResponsePre.textContent = JSON.stringify(data, null, 2);
                    apiResponsePre.classList.add('text-green-400');
                    console.log("Respuesta Exitosa:", data);


                } catch (error) {
                    // Manejo de errores de red o errores lanzados desde la respuesta
                    apiResponsePre.textContent = `Fallo en la Solicitud:\n${error.message}\n\nRevisa la consola para m√°s detalles.`;
                    apiResponsePre.classList.add('text-red-400');
                    console.error("Error completo en la prueba de API:", error);
                } finally {
                    loadingSpinner.classList.add('hidden');
                    solicitarBtn.disabled = false;
                    solicitarBtn.textContent = '‚úÖ SOLICITUD ENVIADA (Haz clic para enviar de nuevo)';
                }
            });
        });
    </script>
</body>
</html>
